<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>果汁梨的导航 (最终版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        :root { --primary: #4361ee; --primary-dark: #3a56d4; --primary-light: #6c8eff; --secondary: #ff6b6b; --success: #06d6a0; --bg: #f5f7fb; --card-bg: #ffffff; --text: #333333; --text-light: #666666; --border: #e1e5eb; --shadow: rgba(149, 157, 165, 0.15); --hover: #f0f2f5; --overlay: rgba(0, 0, 0, 0.5); --glow-color: rgba(67, 97, 238, 0.5); }
        .dark-mode { --primary: #5a75ff; --primary-dark: #4a65e0; --primary-light: #7d94ff; --secondary: #ff8585; --success: #0ce8b0; --bg: #1a1d28; --card-bg: #252a3a; --text: #e1e5f2; --text-light: #a0a7c2; --border: #343a50; --shadow: rgba(0, 0, 0, 0.3); --hover: #2d3344; --overlay: rgba(0, 0, 0, 0.7); --glow-color: rgba(90, 117, 255, 0.5); }
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease; background-image: radial-gradient(circle at 10% 20%, rgba(67, 97, 238, 0.05) 0%, transparent 20%); position: relative; overflow-x: hidden; }
        .dark-mode body { background-image: radial-gradient(circle at 10% 20%, rgba(90, 117, 255, 0.08) 0%, transparent 20%); }
        body.is-editing { box-shadow: inset 0 0 0 3px var(--primary); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; position: relative; z-index: 2; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 40px; position: relative; }
        .logo { display: flex; align-items: center; gap: 12px; font-size: 1.8rem; font-weight: 700; color: var(--primary); cursor: pointer; transition: transform 0.3s, color 0.3s; }
        .logo:hover { transform: translateX(-5px); }
        .logo i { font-size: 2.2rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .controls { display: flex; gap: 15px; align-items: center; }
        .control-btn { background: var(--card-bg); border: 1px solid var(--border); border-radius: 30px; padding: 8px 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; }
        .control-btn:hover { background: var(--hover); }
        #logoutBtn { background-color: var(--secondary); color: white; border-color: var(--secondary); display: none; }
        .search-section { margin-bottom: 50px; }
        .search-box { max-width: 700px; margin: 0 auto; position: relative; }
        .search-box input { width: 100%; padding: 18px 25px; border: none; border-radius: 50px; background: var(--card-bg); box-shadow: 0 5px 15px var(--shadow); font-size: 1.1rem; color: var(--text); padding-left: 60px; outline: none; transition: all 0.3s ease; }
        .search-box input:focus { box-shadow: 0 5px 20px var(--glow-color); transform: scale(1.02); }
        .search-icon { position: absolute; left: 25px; top: 50%; transform: translateY(-50%); color: var(--text-light); font-size: 1.2rem; }
        .search-engines { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .engine-btn { background: var(--card-bg); border: 1px solid var(--border); border-radius: 30px; padding: 8px 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; }
        .engine-btn.active, .engine-btn:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-2px); }
        .categories { margin-bottom: 50px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .section-title { font-size: 1.5rem; display: flex; align-items: center; gap: 10px; transition: color 0.3s; }
        .section-title i { color: var(--primary); transition: color 0.3s; }
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; min-height: 120px; }
        .item-card { background: var(--card-bg); border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px var(--shadow); border: 1px solid var(--border); cursor: pointer; text-decoration: none; display: flex; flex-direction: column; color: inherit; position: relative; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .item-card:hover { box-shadow: 0 8px 30px var(--shadow), 0 0 20px var(--glow-color); border-color: var(--primary); transform: translateY(-5px); }
        .item-card.hidden { display: none !important; }
        .is-editing .item-card:not(.is-inline-editing) { cursor: default; }
        .sortable-ghost { opacity: 0.4; background: var(--primary-light); border: 2px dashed var(--primary); }
        .sortable-chosen { cursor: grabbing !important; }
        .item-card .actions { position: absolute; top: 10px; right: 10px; display: none; align-items: center; gap: 8px; z-index: 5; }
        .is-editing .item-card:hover .actions { display: flex; }
        .action-icon { width: 28px; height: 28px; border-radius: 50%; background: var(--card-bg); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; box-shadow: 0 2px 5px var(--shadow); color: var(--text-light); transition: all 0.2s; cursor: pointer; }
        .action-icon:hover { background: var(--primary); color: white; transform: scale(1.1); }
        .delete-icon:hover { background: var(--secondary); }
        .drag-handle { display: none; position: absolute; top: 10px; left: 10px; color: var(--text-light); cursor: grab; padding: 5px; z-index: 5;}
        .is-editing .drag-handle { display: block; }
        .item-icon { width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: white; font-size: 1.8rem; flex-shrink: 0; transition: background 0.3s; }
        .item-name { font-weight: 600; margin-bottom: 5px; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-desc { color: var(--text-light); font-size: 0.9rem; height: 36px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; flex-grow: 1; }
        .item-card.is-inline-editing { cursor: default; transform: none !important; box-shadow: 0 8px 30px var(--shadow), 0 0 20px var(--glow-color); border-color: var(--primary); padding: 15px; }
        .is-inline-editing .actions, .is-inline-editing .item-icon, .is-inline-editing .item-name, .is-inline-editing .item-desc, .is-inline-editing .drag-handle { display: none !important; }
        .inline-edit-form { display: flex; flex-direction: column; gap: 10px; width: 100%; text-align: left;}
        .inline-edit-form label { margin-bottom: 4px; font-size: 0.8rem; color: var(--text-light); }
        .inline-edit-form input, .inline-edit-form select { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none; transition: border 0.3s; }
        .inline-edit-form input:focus, .inline-edit-form select:focus { border-color: var(--primary); }
        .inline-edit-actions { display: flex; gap: 10px; margin-top: 10px; }
        .inline-edit-actions button { flex-grow: 1; padding: 8px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; transition: background 0.3s; }
        .inline-save-btn { background: var(--primary); color: white; }
        .inline-save-btn:hover { background: var(--primary-dark); }
        .inline-cancel-btn { background: var(--hover); color: var(--text); }
        .add-section { background: var(--card-bg); border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px var(--shadow); border: 1px solid var(--border); margin-bottom: 40px; display: none; }
        .add-section.is-visible { display: block; }
        .add-title { font-size: 1.3rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .add-title i { color: var(--primary); }
        .add-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-light); }
        .form-group input, .form-group select { width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none; transition: border 0.3s; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); }
        .add-btn { background: var(--primary); color: white; border: none; border-radius: 10px; padding: 0 30px; font-weight: 500; cursor: pointer; transition: background 0.3s; height: 44px; grid-column: 1 / -1; }
        .add-btn:hover { background: var(--primary-dark); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
        .modal.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--card-bg); border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px var(--shadow); position: relative; transform: scale(0.95); transition: transform 0.4s ease; }
        .modal.visible .modal-content { transform: scale(1); }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; color: var(--text-light); transition: color 0.3s; }
        .close-modal:hover { color: var(--primary); }
        .modal-title { font-size: 1.5rem; margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; transition: color 0.3s; }
        .settings-section { margin-bottom: 25px; }
        .settings-section h4 { font-size: 1rem; color: var(--text-light); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .setting-item label { font-weight: 500; }
        .theme-toggle { background: var(--card-bg); border: 1px solid var(--border); border-radius: 50px; width: 60px; height: 30px; position: relative; cursor: pointer; box-shadow: 0 2px 5px var(--shadow); }
        .toggle-circle { position: absolute; top: 3px; left: 3px; width: 24px; height: 24px; background: var(--primary); border-radius: 50%; transition: all 0.3s ease; }
        .dark-mode .toggle-circle { left: 33px; }
        #accentColorPicker { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 40px; height: 40px; background-color: transparent; border: none; cursor: pointer; }
        #accentColorPicker::-webkit-color-swatch { border-radius: 50%; border: 2px solid var(--border); }
        #accentColorPicker::-moz-color-swatch { border-radius: 50%; border: 2px solid var(--border); }
        .data-actions { display: flex; gap: 10px; }
        .data-actions .control-btn { padding: 8px 15px; }
        .data-actions #importBtn { background-color: var(--success); color: white; border-color: var(--success);}
        .data-actions #exportBtn { background-color: var(--primary); color: white; border-color: var(--primary);}
        .toast { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); opacity: 0; transform: translateY(20px); transition: all 0.4s cubic-bezier(0.21, 1.35, 0.58, 1); z-index: 2000; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--secondary); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-light); grid-column: 1 / -1; }
        .empty-state i { font-size: 3rem; margin-bottom: 20px; color: var(--primary-light); }
        .empty-state p { margin-top: 10px; }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            header { flex-direction: column; gap: 20px; margin-bottom: 30px;}
            .logo { font-size: 1.6rem; }
            .search-box input { padding: 15px 20px; padding-left: 50px; font-size: 1rem; }
            .search-icon { left: 20px; }
            .section-title { font-size: 1.3rem; }
            .items-grid { grid-template-columns: 1fr 1fr; gap: 15px; }
            .item-icon { width: 50px; height: 50px; font-size: 1.5rem; margin-bottom: 12px; }
            .item-name { font-size: 1rem; }
            .item-desc { font-size: 0.8rem; height: 32px; }
            .add-form { grid-template-columns: 1fr; }
            .item-card:hover { transform: none; }
            .is-editing .item-card.touch-device .actions { display: flex; opacity: 1; }
            .action-icon { width: 36px; height: 36px; font-size: 1rem; }
        }
        @media (max-width: 480px) {
            .items-grid { grid-template-columns: 1fr; }
            .add-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container" id="appContainer">
        <header>
            <div class="logo" id="logo"> <i class="fas fa-compass"></i> <span>果汁梨的导航</span> </div>
            <div class="controls">
                <button class="control-btn" id="settingsBtn" title="设置"><i class="fas fa-cog"></i></button>
                <button class="control-btn" id="editModeBtn"> <i class="fas fa-lock"></i> 进入编辑模式 </button>
                <button class="control-btn" id="logoutBtn"> <i class="fas fa-lock-open"></i> 退出编辑 </button>
            </div>
        </header>

        <section class="search-section">
            <div class="search-box"> <i class="fas fa-search search-icon"></i> <input type="text" id="searchInput" placeholder="实时筛选链接 或 按下回车搜索..."> </div>
            <div class="search-engines"> <button class="engine-btn active" data-engine="google"> <i class="fab fa-google"></i> Google </button> <button class="engine-btn" data-engine="baidu"> <i class="fab fa-baidu"></i> 百度 </button> <button class="engine-btn" data-engine="bing"> <i class="fas fa-search"></i> 必应 </button> <button class="engine-btn" data-engine="github"> <i class="fab fa-github"></i> GitHub </button> </div>
        </section>
        
        <section class="categories">
            <div class="section-header"> <h2 class="section-title"><i class="fas fa-star"></i>常用网站</h2> </div>
            <div class="items-grid" id="commonItems" data-category="common"></div>
        </section>
        <section class="categories">
            <div class="section-header"> <h2 class="section-title"><i class="fas fa-book"></i>学习资源</h2> </div>
            <div class="items-grid" id="learningItems" data-category="learning"></div>
        </section>
        <section class="categories">
            <div class="section-header"> <h2 class="section-title"><i class="fab fa-telegram"></i>Telegram 群组</h2> </div>
            <div class="items-grid" id="telegramItems" data-category="telegram"></div>
        </section>
        <section class="categories">
            <div class="section-header"> <h2 class="section-title"><i class="fas fa-heart"></i>我的收藏</h2> </div>
            <div class="items-grid" id="favoriteItems" data-category="favorite"></div>
        </section>
        
        <section class="add-section">
            <h2 class="add-title"><i class="fas fa-plus-circle"></i>添加新条目</h2>
            <form class="add-form" id="addForm">
                <div class="form-group"> <label for="itemNameInput">名称</label> <input type="text" id="itemNameInput" placeholder="例如：GitHub" required> </div>
                <div class="form-group"> <label for="itemUrlInput">链接</label> <input type="text" id="itemUrlInput" placeholder="例如：https://github.com" required> </div>
                <div class="form-group full-width"> <label for="itemDescInput">描述 (可选)</label> <input type="text" id="itemDescInput" placeholder="添加一个简单的描述..."> </div>
                <div class="form-group full-width"> <label for="itemCategorySelect">分类</label> <select id="itemCategorySelect"> <option value="common">常用网站</option> <option value="learning">学习资源</option> <option value="telegram">Telegram 群组</option> <option value="favorite">我的收藏</option> </select> </div>
                <button type="submit" class="add-btn">添加</button>
            </form>
        </section>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="close-modal" id="closeLoginModal">×</span>
            <h3 class="modal-title">编辑模式</h3>
            <p style="margin-top:-15px; margin-bottom:20px; color:var(--text-light); font-size:0.9rem;">请输入密码以开启或关闭编辑功能</p>
            <form id="loginForm">
                <div class="form-group"> <label for="passwordInput">密码</label> <input type="password" id="passwordInput" required> </div>
                <button type="submit" class="add-btn">确认</button>
            </form>
        </div>
    </div>
    
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <span class="close-modal" id="closeSettingsModal">×</span>
            <h3 class="modal-title"><i class="fas fa-cog"></i> 设置中心</h3>
            <div class="settings-section">
                <h4><i class="fas fa-paint-brush"></i> 外观</h4>
                <div class="setting-item">
                    <label>夜间模式</label>
                    <div class="theme-toggle" id="themeToggle"> <div class="toggle-circle"></div> </div>
                </div>
                <div class="setting-item">
                    <label for="accentColorPicker">自定义主题色</label>
                    <input type="color" id="accentColorPicker" value="#4361ee">
                </div>
            </div>
            <div class="settings-section">
                <h4><i class="fas fa-database"></i> 数据管理</h4>
                <div class="setting-item">
                    <label>备份与恢复 (JSON)</label>
                    <div class="data-actions">
                         <button class="control-btn" id="exportBtn"> <i class="fas fa-download"></i> 导出 </button>
                         <button class="control-btn" id="importBtn"> <i class="fas fa-upload"></i> 导入 </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="editModal">
        <div class="modal-content">
            <span class="close-modal" id="closeEditModal">×</span>
            <h3 class="modal-title">编辑条目</h3>
            <form id="editForm">
                <div class="form-group"> <label for="editItemName">名称</label> <input type="text" id="editItemName" required> </div>
                <div class="form-group"> <label for="editItemUrl">链接</label> <input type="text" id="editItemUrl" required> </div>
                <div class="form-group"> <label for="editItemDesc">描述</label> <input type="text" id="editItemDesc"> </div>
                <div class="form-group"> <label for="editItemCategory">分类</label> <select id="editItemCategory"></select> </div>
                <button type="submit" class="add-btn">保存更改</button>
            </form>
        </div>
    </div>

    <input type="file" id="importFileInput" accept=".json" style="display: none;">
    <div id="toast" class="toast"></div>

    <script>
        // --- COMPLETE AND CORRECTED SCRIPT ---
        const NavigationApp = {
            config: {
                storageKey: 'myNavigationData_GZR_v8_final',
                passwordHash: 'ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f',
                searchEngines: { google: 'https://www.google.com/search?q=', baidu: 'https://www.baidu.com/s?wd=', bing: 'https://www.bing.com/search?q=', github: 'https://github.com/search?q=' },
                defaultData: {
                    common: [{ id: '1', name: "GitHub", url: "https://github.com", desc: "代码托管平台", icon: null }],
                    learning: [{ id: '5', name: "freeCodeCamp", url: "https://freecodecamp.org", desc: "免费编程学习", icon: null }],
                    telegram: [],
                    favorite: []
                }
            },
            state: { itemData: {}, isAllowed: false, currentItemId: null, sortableInstances: [], isTouchDevice: false },
            elements: {},

            init() {
                this.state.isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
                this._cacheDOMElements();
                this._setupEventListeners();
                this._checkPermissions();
                this._loadData();
                this._initTheme();
                this._renderAllCategories();
                if (this.state.isAllowed) this._enterEditMode();
            },

            _cacheDOMElements() {
                this.elements = {
                    container: document.getElementById('appContainer'), body: document.body,
                    searchInput: document.getElementById('searchInput'),
                    addForm: document.getElementById('addForm'), addSection: document.querySelector('.add-section'),
                    loginModal: document.getElementById('loginModal'), loginForm: document.getElementById('loginForm'), closeLoginModalBtn: document.getElementById('closeLoginModal'),
                    editModeBtn: document.getElementById('editModeBtn'), logoutBtn: document.getElementById('logoutBtn'),
                    grids: document.querySelectorAll('.items-grid'), toast: document.getElementById('toast'),
                    settingsBtn: document.getElementById('settingsBtn'), settingsModal: document.getElementById('settingsModal'),
                    closeSettingsModalBtn: document.getElementById('closeSettingsModal'),
                    themeToggle: document.getElementById('themeToggle'), accentColorPicker: document.getElementById('accentColorPicker'),
                    exportBtn: document.getElementById('exportBtn'), importBtn: document.getElementById('importBtn'),
                    importFileInput: document.getElementById('importFileInput'),
                    searchEngines: document.querySelector('.search-engines'),
                    editModal: document.getElementById('editModal'), editForm: document.getElementById('editForm'),
                    closeEditModalBtn: document.getElementById('closeEditModal')
                };
            },
            
            _setupEventListeners() {
                this.elements.editModeBtn.addEventListener('click', () => this.elements.loginModal.classList.add('visible'));
                this.elements.logoutBtn.addEventListener('click', () => this._exitEditMode());
                this.elements.searchInput.addEventListener('keyup', (e) => this._handleSearch(e));

                this.elements.searchEngines.addEventListener('click', (e) => {
                    const btn = e.target.closest('.engine-btn');
                    if (!btn) return;
                    this.elements.searchEngines.querySelector('.engine-btn.active').classList.remove('active');
                    btn.classList.add('active');
                });
                
                this.elements.settingsBtn.addEventListener('click', () => this.elements.settingsModal.classList.add('visible'));
                this.elements.closeSettingsModalBtn.addEventListener('click', () => this.elements.settingsModal.classList.remove('visible'));
                this.elements.settingsModal.addEventListener('click', (e) => { if (e.target === this.elements.settingsModal) this.elements.settingsModal.classList.remove('visible'); });
                
                this.elements.themeToggle.addEventListener('click', () => this._toggleTheme());
                this.elements.accentColorPicker.addEventListener('input', (e) => this._setAccentColor(e.target.value));
                this.elements.accentColorPicker.addEventListener('change', (e) => localStorage.setItem('accentColor', e.target.value));
                
                this.elements.exportBtn.addEventListener('click', () => this._handleExport());
                this.elements.importBtn.addEventListener('click', () => this.elements.importFileInput.click());
                this.elements.importFileInput.addEventListener('change', (e) => this._handleImport(e));
                
                this.elements.loginModal.addEventListener('click', (e) => { if (e.target === this.elements.loginModal) this.elements.loginModal.classList.remove('visible'); });
                this.elements.closeLoginModalBtn.addEventListener('click', () => this.elements.loginModal.classList.remove('visible'));
                this.elements.loginForm.addEventListener('submit', (e) => this._handleLogin(e));
                
                this.elements.addForm.addEventListener('submit', (e) => { e.preventDefault(); this._handleAddItem(); });

                this.elements.editForm.addEventListener('submit', (e) => this._handleSaveItem(e));
                this.elements.closeEditModalBtn.addEventListener('click', () => this._closeEditModal());
                this.elements.editModal.addEventListener('click', (e) => { if (e.target === this.elements.editModal) this._closeEditModal(); });

                this.elements.container.addEventListener('click', (e) => {
                    const card = e.target.closest('.item-card');
                    if (!card) return;
                    const itemId = card.dataset.id;
                    
                    if (e.target.closest('.edit-icon') && this.state.isAllowed) {
                        e.preventDefault();
                        if (window.innerWidth <= 768 || this.state.isTouchDevice) { this._openEditModal(itemId); } 
                        else {
                            if (this.state.currentItemId && this.state.currentItemId !== itemId) { this._renderCard(this.state.currentItemId); }
                            this.state.currentItemId = itemId;
                            const { item, category } = this._findItemById(itemId);
                            this._renderInlineEditForm(card, { ...item, category });
                        }
                    }
                    else if (e.target.closest('.delete-icon') && this.state.isAllowed) { e.preventDefault(); this._handleDeleteItem(itemId); }
                    else if (e.target.closest('.inline-save-btn')) { e.preventDefault(); this._handleInlineSave(card); }
                    else if (e.target.closest('.inline-cancel-btn')) { e.preventDefault(); this._renderCard(itemId); this.state.currentItemId = null; }
                    else if (!e.target.closest('.inline-edit-form') && !e.target.closest('.actions') && !e.target.closest('.drag-handle')) {
                         const { item } = this._findItemById(itemId) || {}; if (item) window.open(item.url, '_blank');
                    }
                });
            },

            _checkPermissions() { this.state.isAllowed = sessionStorage.getItem('isLoggedIn') === 'true'; },
            
            _enterEditMode() {
                this.state.isAllowed = true;
                this.elements.body.classList.add('is-editing');
                this.elements.addSection.classList.add('is-visible');
                this.elements.logoutBtn.style.display = 'flex';
                this.elements.editModeBtn.style.display = 'none';
                this._initSortable();
                this._showToast('已进入编辑模式', 'success');
            },
            _exitEditMode() {
                if (this.state.currentItemId) { this._renderCard(this.state.currentItemId); this.state.currentItemId = null; }
                this.state.isAllowed = false;
                sessionStorage.removeItem('isLoggedIn');
                this.elements.body.classList.remove('is-editing');
                this.elements.addSection.classList.remove('is-visible');
                this.elements.logoutBtn.style.display = 'none';
                this.elements.editModeBtn.style.display = 'flex';
                this._destroySortable();
                this._showToast('已退出编辑模式');
            },

            _loadData() {
                const savedDataString = localStorage.getItem(this.config.storageKey);
                try {
                    if (!savedDataString) {
                        this.state.itemData = JSON.parse(JSON.stringify(this.config.defaultData));
                        return;
                    }
                    const savedData = JSON.parse(savedDataString);
                    this.state.itemData = { ...this.config.defaultData, ...savedData };
                    Object.keys(this.config.defaultData).forEach(key => { if (!Array.isArray(this.state.itemData[key])) { this.state.itemData[key] = []; } });
                } catch(e) { console.error("加载数据失败:", e); this.state.itemData = JSON.parse(JSON.stringify(this.config.defaultData)); }
            },
            _saveData() { if (this.state.isAllowed) localStorage.setItem(this.config.storageKey, JSON.stringify(this.state.itemData)); },
            
            _renderAllCategories() { this.elements.grids.forEach(grid => this._renderCategory(grid.dataset.category)); },
            _renderCategory(category) {
                const container = document.getElementById(`${category}Items`);
                if (!container) return;
                container.innerHTML = '';
                const items = this.state.itemData[category] || [];
                if (items.length > 0) items.forEach(item => container.appendChild(this._createItemCard(item)));
                else this._showEmptyState(container);
            },
            _showEmptyState(container) { container.innerHTML = `<div class="empty-state"><i class="fas fa-folder-open"></i><h3>暂无内容</h3><p>请进入编辑模式后添加</p></div>`; },
            
            _initTheme() {
                if (localStorage.getItem('darkMode') === 'true') this.elements.body.classList.add('dark-mode');
                const savedColor = localStorage.getItem('accentColor') || '#4361ee';
                this._setAccentColor(savedColor);
            },
            _toggleTheme() {
                this.elements.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', this.elements.body.classList.contains('dark-mode'));
            },
            _setAccentColor(hex) {
                this.elements.accentColorPicker.value = hex;
                document.documentElement.style.setProperty('--primary', hex);
                const [h, s, l] = this._hexToHsl(hex);
                document.documentElement.style.setProperty('--primary-light', `hsl(${h}, ${s}%, ${Math.min(100, l + 15)}%)`);
                document.documentElement.style.setProperty('--primary-dark', `hsl(${h}, ${s}%, ${Math.max(0, l - 10)}%)`);
                document.documentElement.style.setProperty('--glow-color', `hsla(${h}, ${s}%, ${l}%, 0.5)`);
            },
            _hexToHsl(H) {let r=0,g=0,b=0;if(H.length==4){r="0x"+H[1]+H[1];g="0x"+H[2]+H[2];b="0x"+H[3]+H[3]}else if(H.length==7){r="0x"+H[1]+H[2];g="0x"+H[3]+H[4];b="0x"+H[5]+H[6]}r/=255;g/=255;b/=255;let cmin=Math.min(r,g,b),cmax=Math.max(r,g,b),delta=cmax-cmin,h=0,s=0,l=0;if(delta==0)h=0;else if(cmax==r)h=((g-b)/delta)%6;else if(cmax==g)h=(b-r)/delta+2;else h=(r-g)/delta+4;h=Math.round(h*60);if(h<0)h+=360;l=(cmax+cmin)/2;s=delta==0?0:(delta/(1-Math.abs(2*l-1)));s=+(s*100).toFixed(1);l=+(l*100).toFixed(1);return[h,s,l]},

            _handleSearch(e) {
                const query = e.target.value;
                if (e.key === 'Enter') {
                    if (!query.trim()) return;
                    const activeEngineKey = this.elements.searchEngines.querySelector('.engine-btn.active').dataset.engine;
                    const searchUrl = this.config.searchEngines[activeEngineKey] + encodeURIComponent(query);
                    window.open(searchUrl, '_blank');
                } else { this._filterItems(query); }
            },
            _filterItems(query) {
                const lowerCaseQuery = query.toLowerCase();
                document.querySelectorAll('.item-card').forEach(card => {
                    const result = this._findItemById(card.dataset.id);
                    if (result) {
                        const isVisible = result.item.name.toLowerCase().includes(lowerCaseQuery) || (result.item.desc && result.item.desc.toLowerCase().includes(lowerCaseQuery));
                        card.classList.toggle('hidden', !isVisible);
                    }
                });
            },

            _getFaviconUrl(itemUrl) { try { const url = new URL(itemUrl); return `https://www.google.com/s2/favicons?sz=64&domain_url=${url.hostname}`; } catch (e) { return null; } },
            _createItemCard(item) {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.dataset.id = item.id;
                if (this.state.isTouchDevice) card.classList.add('touch-device');
                this._updateCardContent(card, item);
                return card;
            },
            _updateCardContent(card, item) {
                let iconHtml;
                if (item.icon) { iconHtml = `<i class="${item.icon}"></i>`; }
                else { const faviconUrl = this._getFaviconUrl(item.url); iconHtml = faviconUrl ? `<img src="${faviconUrl}" alt="" style="width: 28px; height: 28px; border-radius: 50%;" onerror="this.parentElement.innerHTML = '<i class=\\'fas fa-link\\'></i>'; this.style.display='none';">` : `<i class="fas fa-link"></i>`; }
                card.innerHTML = `<div class="drag-handle" title="拖拽排序"><i class="fas fa-grip-lines"></i></div><div class="actions"><div class="action-icon edit-icon" title="编辑"><i class="fas fa-edit"></i></div><div class="action-icon delete-icon" title="删除"><i class="fas fa-trash"></i></div></div><div class="item-icon">${iconHtml}</div><div class="item-name" title="${item.name}">${item.name}</div><div class="item-desc" title="${item.desc || ''}">${item.desc || ''}</div>`;
                card.classList.remove('is-inline-editing');
            },
            _renderInlineEditForm(card, item) {
                card.classList.add('is-inline-editing');
                const categoryOptions = Object.keys(this.config.defaultData).map(cat => `<option value="${cat}" ${cat === item.category ? 'selected' : ''}>${this._getCategoryName(cat)}</option>`).join('');
                card.innerHTML = `<div class="inline-edit-form"><div class="form-group"><label>名称</label><input type="text" class="inline-name" value="${item.name}"></div><div class="form-group"><label>链接</label><input type="text" class="inline-url" value="${item.url}"></div><div class="form-group"><label>描述</label><input type="text" class="inline-desc" value="${item.desc || ''}"></div><div class="form-group"><label>分类</label><select class="inline-category">${categoryOptions}</select></div><div class="inline-edit-actions"><button class="inline-save-btn">保存</button><button class="inline-cancel-btn">取消</button></div></div>`;
            },
            _renderCard(itemId) {
                const result = this._findItemById(itemId);
                const card = document.querySelector(`.item-card[data-id="${itemId}"]`);
                if(result && card) this._updateCardContent(card, result.item);
            },
            
            _initSortable() {
                this._destroySortable();
                this.elements.grids.forEach(grid => {
                    const sortable = new Sortable(grid, { handle: '.drag-handle', group: 'shared', animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', onEnd: (evt) => { if (!this.state.isAllowed) return; const fromCategory = evt.from.dataset.category; const toCategory = evt.to.dataset.category; const [draggedItem] = this.state.itemData[fromCategory].splice(evt.oldIndex, 1); this.state.itemData[toCategory].splice(evt.newIndex, 0, draggedItem); this._saveData(); } });
                    this.state.sortableInstances.push(sortable);
                });
            },
            _destroySortable() { this.state.sortableInstances.forEach(instance => instance.destroy()); this.state.sortableInstances = []; },

            _handleAddItem() {
                const form = this.elements.addForm;
                const name = form.querySelector('#itemNameInput').value.trim();
                let url = form.querySelector('#itemUrlInput').value.trim();
                const desc = form.querySelector('#itemDescInput').value.trim();
                const category = form.querySelector('#itemCategorySelect').value;
                if (!name || !url) { this._showToast('名称和链接不能为空！', 'error'); return; }
                if (!url.match(/^(https?:\/\/|tg:\/\/|ftp:\/\/)/i)) url = 'https://' + url;
                const newItem = { id: crypto.randomUUID(), name, url, desc: desc || " ", icon: category === 'telegram' ? 'fab fa-telegram' : null };
                if(!this.state.itemData[category]) this.state.itemData[category] = [];
                this.state.itemData[category].push(newItem);
                this._saveData();
                this._renderCategory(category);
                this._showToast(`“${name}”已添加`, 'success');
                form.reset();
            },
            
            _findItemById(itemId) {
                for (const category in this.state.itemData) {
                    const itemIndex = this.state.itemData[category].findIndex(i => i.id === itemId);
                    if (itemIndex !== -1) return { item: this.state.itemData[category][itemIndex], category, index: itemIndex };
                }
                return null;
            },
            
            _openEditModal(itemId) {
                const result = this._findItemById(itemId);
                if (!result) return;
                this.state.currentItemId = itemId;
                const form = this.elements.editForm;
                form.querySelector('#editItemName').value = result.item.name;
                form.querySelector('#editItemUrl').value = result.item.url;
                form.querySelector('#editItemDesc').value = result.item.desc || '';
                const categorySelect = form.querySelector('#editItemCategory');
                categorySelect.innerHTML = Object.keys(this.config.defaultData).map(cat => `<option value="${cat}" ${cat === result.category ? 'selected' : ''}>${this._getCategoryName(cat)}</option>`).join('');
                this.elements.editModal.classList.add('visible');
            },
            _closeEditModal() {
                this.elements.editModal.classList.remove('visible');
                this.state.currentItemId = null;
            },
            _handleSaveItem(e) {
                e.preventDefault();
                const form = this.elements.editForm;
                const newData = {
                    name: form.querySelector('#editItemName').value.trim(),
                    url: form.querySelector('#editItemUrl').value.trim(),
                    desc: form.querySelector('#editItemDesc').value.trim() || ' '
                };
                const newCategory = form.querySelector('#editItemCategory').value;
                if (!newData.name || !newData.url) { this._showToast('名称和链接不能为空！', 'error'); return; }
                this._updateItemData(this.state.currentItemId, newData, newCategory);
                this._closeEditModal();
            },
            _handleInlineSave(cardElement) {
                const newData = {
                    name: cardElement.querySelector('.inline-name').value.trim(),
                    url: cardElement.querySelector('.inline-url').value.trim(),
                    desc: cardElement.querySelector('.inline-desc').value.trim() || ' '
                };
                const newCategory = cardElement.querySelector('.inline-category').value;
                if (!newData.name || !newData.url) { this._showToast('名称和链接不能为空！', 'error'); return; }
                this._updateItemData(cardElement.dataset.id, newData, newCategory);
            },
            _updateItemData(itemId, newData, newCategory) {
                const result = this._findItemById(itemId);
                if (!result) return;
                const { category: oldCategory, index } = result;
                const [itemToMove] = this.state.itemData[oldCategory].splice(index, 1);
                Object.assign(itemToMove, newData);
                itemToMove.icon = newCategory === 'telegram' ? 'fab fa-telegram' : null;
                if (!this.state.itemData[newCategory]) this.state.itemData[newCategory] = [];
                this.state.itemData[newCategory].push(itemToMove);
                this._saveData();
                if (oldCategory !== newCategory) { this._renderCategory(oldCategory); this._renderCategory(newCategory); } 
                else { this._renderCard(itemId); }
                this.state.currentItemId = null;
                this._showToast('条目已更新！', 'success');
            },
            
            _handleDeleteItem(itemId) {
                if (!confirm('确定要删除这个条目吗？')) return;
                const result = this._findItemById(itemId);
                if (result) {
                    const { item, category, index } = result;
                    this.state.itemData[category].splice(index, 1);
                    this._saveData();
                    document.querySelector(`.item-card[data-id="${itemId}"]`).remove();
                    this._showToast(`“${item.name}”已删除`);
                }
            },
            
            _handleExport() {
                const dataStr = JSON.stringify(this.state.itemData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'my_navigation_backup.json';
                let linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                this._showToast("配置已导出！", 'success');
            },
            _handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                if (!confirm("导入配置将覆盖现有所有数据，确定吗？")) { event.target.value = ""; return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (typeof importedData === 'object' && !Array.isArray(importedData)) {
                             this.state.itemData = importedData;
                             this._saveData();
                             this._renderAllCategories();
                             this._showToast("配置导入成功！", 'success');
                        } else { throw new Error("文件格式不正确"); }
                    } catch (err) {
                        this._showToast("导入失败，请检查文件格式！", 'error'); console.error("导入错误: ", err);
                    } finally { event.target.value = ""; }
                };
                reader.readAsText(file);
            },
            
            async _sha256(message) {
                const msgBuffer = new TextEncoder().encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },
            async _handleLogin(e) {
                e.preventDefault();
                const passwordInput = this.elements.loginForm.querySelector('#passwordInput');
                const password = passwordInput.value;
                const hashedInput = await this._sha256(password);
                if (hashedInput === this.config.passwordHash) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    this.elements.loginModal.classList.remove('visible');
                    passwordInput.value = '';
                    this._enterEditMode();
                } else { this._showToast('密码错误！', 'error'); }
            },
            
            _getCategoryName(category) { const names = { 'common': '常用网站', 'learning': '学习资源', 'telegram': 'Telegram 群组', 'favorite': '我的收藏' }; return names[category] || '未知分类'; },
            _showToast(message, type = 'info') {
                const toast = this.elements.toast;
                toast.textContent = message;
                toast.className = 'toast show'; // Reset classes
                if (type === 'success') {
                    toast.classList.add('success');
                } else if (type === 'error') {
                    toast.classList.add('error');
                }
                setTimeout(() => { toast.classList.remove('show'); }, 3000);
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            NavigationApp.init();
        });
    </script>
</body>
</html>